@page "/fetchdata"
@inject HttpClient Http
@using Poke.MoveTranslator.PWA.Services
@using PokeApiNet
@using Newtonsoft.Json
@using Blazored.LocalStorage
@using System.Collections.ObjectModel
@using System.Collections.Specialized
@inject IPokemonApi PokeApiService
@inject ILocalStorageService LocalStorageService

<PageTitle>Weather forecast</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Poke move</MudText>
<MudText Class="mb-8">This component demonstrates fetching data from the server.</MudText>

@if (!IsInitializing)
{
    <MudGrid Justify="@Justify.Center">
        <MudItem xs="12" sm="6" md="2">
            @if (LastValues.Count == 0)
            {
                <MudTextField @bind-Value="MoveName" Label="Move name" Variant="Variant.Text" Disabled="@IsLoading"></MudTextField>
            }
            else
            {
                <MudAutocomplete T="string" @bind-Value="MoveName" Label="Move name" AnchorOrigin="Origin.BottomCenter" Disabled="@IsLoading" CoerceValue="true" SearchFunc="@(_ => Task.FromResult(LastValues.AsEnumerable()))">
                    <MudText>aaaa</MudText>
                    @foreach (var item in LastValues)
                    {
                        <MudSelectItem Value="@item"/>
                    }
                </MudAutocomplete>
            }
        </MudItem>
        <MudItem xs="12" sm="6" md="6">
            <MudSelect T="string" @bind-Value="Language" Label="Language" AnchorOrigin="Origin.BottomCenter" Disabled="@IsLoading">
                @foreach (string languageCode in languages.Keys)
                {
                    <MudSelectItem Value="@languageCode">@(languages[languageCode])</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudFab Color="Color.Primary" Icon="@Icons.Material.Filled.PlayCircleFilled" aria-label="play" OnClick="@LoadMove" Class="ml-auto d-flex d-sm-inline-flex"/>
        </MudItem>
    </MudGrid>
}

@if (IsLoading || IsInitializing)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true"/>
}
else if (Move != null)
{
    <div>English Name: @Move.Names.First(n => n.Language.Name == "en").Name</div>

    @JsonConvert.SerializeObject(Move)
}

@code {
    private Dictionary<string, string> languages;

    public string MoveName { get; set; }
    public bool IsLoading { get; set; }
    public bool IsInitializing { get; set; }
    public Move Move { get; set; }

    public string Language
    {
        get => _language;
        set
        {
            bool wasNull = string.IsNullOrWhiteSpace(_language);
            _language = value;
            if (!wasNull)
            {
                OnLanguageChange();
            }
        }
    }
    
    public ObservableCollection<string> LastValues { get; set; }

    private void OnLanguageChange()
    {
        LocalStorageService.SetItemAsync("LastLanguage", Language);
    }

    private string _language;

    protected override async Task OnInitializedAsync()
    {
        IsInitializing = true;
        languages = await PokeApiService.GetLanguages();
        Language = await LocalStorageService.GetItemAsync<string>("LastLanguage");
        LastValues = new ObservableCollection<string>(await LocalStorageService.GetItemAsync<string[]>("LastValues") ?? Array.Empty<string>());
        LastValues.CollectionChanged += async (_, a) =>
        {
            await LocalStorageService.SetItemAsync<string[]>("LastValues", LastValues.ToArray());
            if (LastValues.Count > 10 && a.Action == NotifyCollectionChangedAction.Add)
            {
                LastValues.RemoveAt(0);
            }
        };
        IsInitializing = false;
    }

    public class WeatherForecast
    {
        public DateTime Date { get; set; }

        public int TemperatureC { get; set; }

        public string Summary { get; set; }

        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
    }

    private async Task LoadMove()
    {
        IsLoading = true;
        Move = await PokeApiService.GetMove(MoveName, Language);

        if (!LastValues.Contains(MoveName))
        {
            LastValues.Add(MoveName);
        }

        IsLoading = false;
    }

}